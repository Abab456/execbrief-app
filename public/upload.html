<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Decision Brief ‚Äî ExecBrief</title>

  <link rel="stylesheet" href="/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
</head>

<body class="dashboard-body">

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-header">
    <div class="logo">ExecBrief</div>
  </div>

  <nav class="sidebar-nav">
    <a href="/dashboard" class="nav-link">üìä Overview</a>
    <a href="/upload" class="nav-link active">üß† Decision Brief</a>
    <a href="/settings" class="nav-link">‚öôÔ∏è Settings</a>
    <a href="#" id="logout-btn" class="nav-link danger">üö™ Logout</a>
  </nav>
</aside>

<main class="main-content">

<header class="top-bar">
  <div>
    <h2>Decision Brief</h2>
    <div class="muted">Generate executive insights from your data</div>
  </div>
  <div class="user-profile">üë§ <span id="user-name">Loading...</span></div>
</header>

<section class="grid-3">

<!-- FILE UPLOAD -->
<div class="dashboard-card" style="grid-column:span 2;">
  <h3>Add data sources</h3>
  <div class="muted">CSV, XLSX (MVP)</div>

  <div id="dropzone" class="dropzone">
    <strong>Drop files here</strong>
    <div class="muted">or browse</div>
    <input id="fileInput" type="file" multiple accept=".csv,.xlsx,.xls" hidden />
    <button id="browseBtn" class="nav-btn">Browse files</button>
  </div>

  <div id="fileList"></div>
</div>

<!-- CONTEXT + MODE -->
<div class="dashboard-card">
  <h3>Decision context</h3>

  <textarea id="context" rows="5"
    placeholder="Example: Why did CAC spike last month?"></textarea>

  <!-- MODE TOGGLE -->
  <div style="margin-top:12px;">
    <label style="font-weight:900;">Analysis mode</label>
    <div style="display:flex; gap:10px; margin-top:8px;">
      <button class="mode-btn active" data-mode="exec">Executive</button>
      <button class="mode-btn" data-mode="diagnostic">Diagnostic</button>
      <button class="mode-btn" data-mode="explore">Exploratory</button>
    </div>
    <input type="hidden" id="mode" value="exec" />
  </div>

  <button id="generateBtn" class="btn-primary" style="margin-top:14px;">
    Generate brief
  </button>

  <div id="msgBox" class="alert" style="display:none; margin-top:10px;"></div>
</div>

</section>

<!-- OUTPUT -->
<section id="execBriefUI" style="display:none; margin-top:18px;">
  <div id="execSummary" class="dashboard-card"></div>
  <div id="signalsGrid" class="grid-auto"></div>
  <div id="actionsList"></div>
</section>

</main>

<script>
/* INIT */
async function loadUser() {
  const r = await fetch("/api/profile",{credentials:"include"});
  if (r.status===401) location.href="/login";
  const d = await r.json();
  document.getElementById("user-name").innerText=d.name||"User";
}
loadUser();

/* LOGOUT */
document.getElementById("logout-btn").onclick=async e=>{
  e.preventDefault();
  await fetch("/api/logout",{method:"POST",credentials:"include"});
  location.href="/login";
};

/* FILE HANDLING */
const fileInput=document.getElementById("fileInput");
const browseBtn=document.getElementById("browseBtn");
const fileList=document.getElementById("fileList");
let files=[];
browseBtn.onclick=()=>fileInput.click();
fileInput.onchange=e=>{files.push(...e.target.files);renderFiles();};

function renderFiles(){
  fileList.innerHTML=files.map((f,i)=>`
    <div class="metric-card">
      <strong>${f.name}</strong>
      <span class="muted">${(f.size/1024).toFixed(1)} KB</span>
      <button onclick="removeFile(${i})">Remove</button>
    </div>`).join("");
}
window.removeFile=i=>{files.splice(i,1);renderFiles();};

/* MODE TOGGLE */
const modeInput=document.getElementById("mode");
document.querySelectorAll(".mode-btn").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".mode-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    modeInput.value=btn.dataset.mode;
  };
});

/* GENERATE */
document.getElementById("generateBtn").onclick=async()=>{
  const msg=document.getElementById("msgBox");
  msg.style.display="block";
  msg.innerText="Generating‚Ä¶";

  if(!files.length){msg.innerText="Upload at least one file";return;}

  const fd=new FormData();
  files.forEach(f=>fd.append("files",f));
  fd.append("context",context.value);
  fd.append("mode",modeInput.value);

  const r=await fetch("/api/upload",{method:"POST",body:fd,credentials:"include"});
  const d=await r.json();

  if(!r.ok){msg.innerText=d.error||"Failed";return;}
  msg.innerText="Ready ‚úÖ";
  renderExecBrief(d.brief);
};

/* RENDER */
function renderExecBrief(brief){
  document.getElementById("execBriefUI").style.display="block";

  if(brief.mode==="diagnostic"){
    execSummary.innerHTML = `<strong>Root Cause Analysis</strong><br>${brief.summary}`;
    signalsGrid.innerHTML = (brief.root_causes||[]).map(r=>`
      <div class="dashboard-card">
        <strong>${r.cause}</strong>
        <div>${r.explanation}</div>
        <div class="muted">Confidence ${r.confidence}%</div>
      </div>`).join("");
    actionsList.innerHTML="";
    return;
  }

  execSummary.innerText=brief.executive_summary||"";
}
</script>

</body>
</html>
